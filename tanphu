-- Brainrot Strongest TP + Drop Clone (AUTO AnimalPodiums, TP + drop đúng chỗ)
-- Loader (Delta):
-- loadstring(game:HttpGet("https://raw.githubusercontent.com/LVTP1312/tanphu/main/tanphu"))()

-- ================== Services ==================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")
local ContextActionService = game:GetService("ContextActionService")

local LP = Players.LocalPlayer

-- ================== MPS helpers ==================
local function textIsPerSec(s)
    s = tostring(s or ""):lower()
    return (s:find("/s", 1, true) ~= nil)
        or s:find("per%s*sec")
        or s:find("per%s*second")
end

local function parseMPS(val)
    if typeof(val) == "number" then
        return val
    end
    if typeof(val) ~= "string" then
        return 0
    end
    local s = val:lower()
    s = s:gsub(",", ""):gsub("%s+", ""):gsub("%$", "")
    local num = tonumber((s:match("([%d%.]+)")) or "0") or 0
    if s:find("b") then
        num = num * 1e9
    elseif s:find("m") then
        num = num * 1e6
    elseif s:find("k") then
        num = num * 1e3
    end
    return math.floor(num + 0.5)
end

local ALLOW_NAME_TOKENS = {
    "mps",
    "moneypersec",
    "money_per_sec",
    "moneypersecond",
    "persec",
    "per_second",
    "gen",
    "generation",
}
local DENY_TOKENS = {
    "offline",
    "cash",
    "total",
    "bank",
    "balance",
    "wallet",
    "coins",
    "gems",
    "price",
    "cost",
    "buy",
    "sell",
    "collect",
    "collected",
}

local function hasToken(s, toks)
    s = tostring(s or ""):lower()
    for _, t in ipairs(toks) do
        if s:find(t, 1, true) then
            return true
        end
    end
    return false
end

-- đọc MPS quanh 1 inst (attributes + descendants)
local function collectMPSFrom(inst)
    local best = 0
    if not inst then
        return best
    end

    -- 1) Attributes thường gặp
    for _, k in ipairs({ "MPS", "MoneyPerSec", "MoneyPerSecond", "Gen", "Generation" }) do
        local a = inst:GetAttribute(k)
        if typeof(a) == "number" and a > 0 then
            best = math.max(best, a)
        elseif typeof(a) == "string" and textIsPerSec(a) then
            best = math.max(best, parseMPS(a))
        end
    end

    -- 2) Descendants (TextLabel / StringValue / NumberValue, v.v.)
    local ok, descs = pcall(inst.GetDescendants, inst)
    if ok and type(descs) == "table" then
        local step = 0
        for i = 1, #descs do
            local d = descs[i]
            step += 1
            if step % 250 == 0 then
                RunService.Heartbeat:Wait()
            end

            local nm = tostring(d.Name or ""):lower()
            if not hasToken(nm, DENY_TOKENS) then
                if d:IsA("TextLabel") or d:IsA("TextButton") then
                    local t = tostring(d.Text or "")
                    if t ~= "" and textIsPerSec(t) and not hasToken(t, DENY_TOKENS) then
                        best = math.max(best, parseMPS(t))
                    end
                elseif d:IsA("StringValue") then
                    local v = d.Value
                    if type(v) == "string" and textIsPerSec(v) and not hasToken(v, DENY_TOKENS) then
                        best = math.max(best, parseMPS(v))
                    end
                elseif d:IsA("NumberValue") or d:IsA("IntValue") then
                    local n = tonumber(d.Value) or 0
                    if n > 0 and hasToken(nm, ALLOW_NAME_TOKENS) then
                        best = math.max(best, n)
                    end
                end
            end
        end
    end

    return best
end

-- ================== chọn BasePart để TP ==================
local function pickTargetPart(inst)
    if not inst then
        return nil
    end
    if inst:IsA("Model") and inst.PrimaryPart then
        return inst.PrimaryPart
    end
    if inst:IsA("BasePart") then
        return inst
    end
    local ok, descs = pcall(inst.GetDescendants, inst)
    if ok and type(descs) == "table" then
        local best, topY = nil, -math.huge
        for _, d in ipairs(descs) do
            if d:IsA("BasePart") then
                local pos = d.Position
                if typeof(pos) == "Vector3" and pos.Y > topY then
                    topY = pos.Y
                    best = d
                end
            end
        end
        if best then
            return best
        end
    end
    if inst.Parent then
        return pickTargetPart(inst.Parent)
    end
    return nil
end

-- ================== tìm pet MPS cao nhất ==================
local function findBestFromAnimalPodiums()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        return nil, 0
    end
    local bestInst, bestVal = nil, 0

    for _, plot in ipairs(plots:GetChildren()) do
        local animalPodiums = plot:FindFirstChild("AnimalPodiums")
        if animalPodiums then
            for _, podium in ipairs(animalPodiums:GetChildren()) do
                local mps = collectMPSFrom(podium)
                if mps > 0 and mps > bestVal then
                    bestVal = mps
                    bestInst = podium
                end
            end
        end
    end

    if bestInst then
        print("[BrainrotTP] Best from AnimalPodiums:", bestInst:GetFullName(), "MPS =", bestVal)
    else
        print("[BrainrotTP] Không tìm thấy MPS trong Plots.AnimalPodiums.")
    end

    return bestInst, bestVal
end

local function findBestFromWorkspace()
    local bestInst, bestVal = nil, 0
    local ok, descs = pcall(workspace.GetDescendants, workspace)
    if not ok or type(descs) ~= "table" then
        return nil, 0
    end
    local step = 0
    for _, inst in ipairs(descs) do
        step += 1
        if step % 400 == 0 then
            RunService.Heartbeat:Wait()
        end

        local mps = 0
        mps = math.max(mps, collectMPSFrom(inst))
        mps = math.max(mps, collectMPSFrom(inst.Parent))
        mps = math.max(mps, collectMPSFrom(inst.Parent and inst.Parent.Parent))

        if mps > 0 and mps > bestVal then
            bestVal = mps
            bestInst = inst
        end
    end

    if bestInst then
        print("[BrainrotTP] Best from workspace fallback:", bestInst:GetFullName(), "MPS =", bestVal)
    else
        print("[BrainrotTP] Fallback workspace cũng không tìm được con nào có MPS.")
    end

    return bestInst, bestVal
end

local function findStrongestPet()
    local inst, val = findBestFromAnimalPodiums()
    if inst then return inst, val end
    return findBestFromWorkspace()
end

-- ================== UseItem remote ==================
local Net = nil
do
    local okP, Packages = pcall(function()
        return ReplicatedStorage:WaitForChild("Packages", 5)
    end)
    if okP and Packages then
        pcall(function()
            Net = require(Packages:WaitForChild("Net", 5))
        end)
    end
end

local function getUseItem()
    if Net and Net.RemoteEvent then
        local ok, re = pcall(function()
            return Net:RemoteEvent("UseItem")
        end)
        if ok and re then
            return function()
                re:FireServer()
            end
        end
    end
    return function()
        warn("[BrainrotTP] UseItem remote not found (cannot drop clone).")
    end
end

local fireUseItem = getUseItem()

-- ================== Ping + debounce + clone check ==================
local function getPingSec()
    local ok, ms = pcall(function()
        local s = Stats.Network.ServerStatsItem["Data Ping"]:GetValueString()
        local num = tonumber(string.match(s or "", "%d+")) or 120
        return num
    end)
    local msPing = ok and ms or 120
    return msPing / 1000
end

local lastCall = 0
local function notCoolingDown(cd)
    local now = os.clock()
    if now - lastCall < (cd or 3) then
        return false
    end
    lastCall = now
    return true
end

local function cloneExists()
    return workspace:FindFirstChild(("%s_Clone"):format(LP.UserId)) ~= nil
end

-- ================== MAIN ACTION: TP + ĐỢI RẤT NGẮN + SPAM DROP ==================
local function doTpAndDrop()
    local inst, bestVal = findStrongestPet()
    if not inst then
        warn("[BrainrotTP] Không tìm thấy pet/ podium nào có MPS.")
        return
    end

    print("[BrainrotTP] Final target:", inst:GetFullName(), "MPS =", bestVal)

    local part = pickTargetPart(inst)
    if not part then
        warn("[BrainrotTP] Không tìm được BasePart của: " .. inst:GetFullName())
        return
    end

    local cf = part.CFrame

    local char = LP.Character or LP.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        warn("[BrainrotTP] Không tìm thấy HumanoidRootPart.")
        return
    end

    -- 1) TP client tới podium
    hrp.CFrame = cf + Vector3.new(0, 3, 0)

    -- 2) ĐỢI RẤT NGẮN THEO PING (cho server cập nhật vị trí mới)
    --    làm sát hơn: min 0.08s, max 0.20s
    local delay = math.clamp(getPingSec() * 0.3, 0.08, 0.20)
    task.wait(delay)

    -- 3) Vừa giữ player dính podium, vừa spam UseItem trong 0.18–0.45s
    local start = os.clock()
    local duration = math.clamp(getPingSec() * 0.8, 0.18, 0.45)

    while os.clock() - start < duration do
        -- "ghim" player tại vị trí podium để hạn chế bị kéo lệch
        hrp.CFrame = cf + Vector3.new(0, 3, 0)

        fireUseItem()
        RunService.Heartbeat:Wait()

        if cloneExists() then
            break
        end
    end

    -- 4) Thêm 1 phát dự phòng ngay sau đó
    if not cloneExists() then
        fireUseItem()
    end
end

-- ================== Keybind T + CAS button ==================
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then
        return
    end
    if input.UserInputType ~= Enum.UserInputType.Keyboard then
        return
    end
    if UserInputService:GetFocusedTextBox() then
        return
    end
    if input.KeyCode == Enum.KeyCode.T then
        print("[BrainrotTP] T pressed")
        tpAndDropClone()
    end
end)

local function StrongestTPActionHandler(_, inputState)
    if inputState == Enum.UserInputState.Begin then
        print("[BrainrotTP] CLONE button pressed")
        tpAndDropClone()
    end
end

ContextActionService:BindAction(
    "BrainrotStrongTP",
    StrongestTPActionHandler,
    true,
    Enum.KeyCode.T
)
ContextActionService:SetTitle("BrainrotStrongTP", "CLONE")
ContextActionService:SetPosition("BrainrotStrongTP", UDim2.new(1, -120, 1, -150))

print("[BrainrotTP] Loaded. Press T or tap CLONE để auto TP tới podium MPS cao nhất và drop clone đúng chỗ.")
