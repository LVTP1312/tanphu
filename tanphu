--==================================================
-- üß™ TANPHU PETS FINDER ‚Äì TEST NOTIFY
--  Qu√©t pet trong server, g·ª≠i list l√™n Discord ƒë·ªÉ ki·ªÉm tra
--==================================================
repeat task.wait() until game:IsLoaded()

local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- üëâ D√πng webhook test (·ªü ƒë√¢y m√¨nh d√πng webhook over 50M c·ªßa b·∫°n)
local WEBHOOK_DEBUG = "https://discordapp.com/api/webhooks/1410314122670903491/KD8clDHrbOMKlArHAoEyMXTqQGD6AAN7ftlYvdkFEOj5a9_VEGA9yqAhoH2XPK77TITb"

-- Ch·ªçn HTTP impl
local http_request_impl =
    (typeof(syn) == "table" and typeof(syn.request) == "function" and syn.request)
    or (typeof(http_request) == "function" and http_request)
    or (typeof(request) == "function" and request)
    or (typeof(http) == "table" and typeof(http.request) == "function" and http.request)

if not http_request_impl then
    warn("‚ùå TEST: Kh√¥ng t√¨m th·∫•y HTTP request (syn/http_request/request/http.request)")
    return
end

--==================================================
-- üí∞ H√ÄM CHUY·ªÇN MPS TEXT ‚Üí S·ªê TH·∫¨T
--   V√≠ d·ª•: "$135M/s" -> 135000000 ; "$800K/s" -> 800000 ; "2.3B" -> 2300000000
--==================================================
local function parseMps(raw)
    if raw == nil then return 0 end
    if typeof(raw) == "number" then
        return raw
    end

    local s = tostring(raw):gsub(",", ""):gsub("%s+", ""):upper()
    local num = tonumber(s:match("([%d%.]+)")) or 0

    if s:find("B") then
        return num * 1e9
    elseif s:find("M") then
        return num * 1e6
    elseif s:find("K") then
        return num * 1e3
    else
        return num
    end
end

local function formatMpsShort(v)
    v = tonumber(v) or 0
    if v >= 1e9 then
        return string.format("%.2fB", v/1e9)
    elseif v >= 1e6 then
        return string.format("%.2fM", v/1e6)
    elseif v >= 1e3 then
        return string.format("%.2fK", v/1e3)
    else
        return tostring(math.floor(v))
    end
end

--==================================================
-- üîé L·∫§Y MPS T·ª™ 1 PET (MODEL/FOLDER)
--   1) N·∫øu c√≥ child t√™n "MPS" th√¨ d√πng
--   2) N·∫øu kh√¥ng, t√¨m TextLabel/TextButton c√≥ text ch·ª©a "/s"
--==================================================
local function getMpsFromPet(pet)
    local mpsObj = pet:FindFirstChild("MPS")
    if mpsObj and mpsObj.Value ~= nil then
        return parseMps(mpsObj.Value), "Value:" .. tostring(mpsObj.Value)
    end

    local bestText = nil
    for _, d in ipairs(pet:GetDescendants()) do
        if d:IsA("TextLabel") or d:IsA("TextButton") then
            local t = d.Text
            if t and t ~= "" then
                local up = t:upper()
                if up:find("/S") or up:find("M/S") or up:find("PERSEC") then
                    bestText = t
                    break
                end
            end
        end
    end

    if bestText then
        return parseMps(bestText), "Text:" .. bestText
    end

    return 0, nil
end

--==================================================
-- üìã QU√âT DANH S√ÅCH PET TRONG SERVER
--==================================================
local function collectPets()
    local result = {}

    local petsFolder = workspace:FindFirstChild("Pets")
    local candidates = {}

    if petsFolder then
        candidates = petsFolder:GetChildren()
        print("[TEST] D√πng workspace.Pets, count =", #candidates)
    else
        -- fallback: qu√©t c√°c Model tr·ª±c ti·∫øp d∆∞·ªõi workspace
        print("[TEST] Kh√¥ng c√≥ workspace.Pets, qu√©t Model d∆∞·ªõi workspace")
        for _, inst in ipairs(workspace:GetChildren()) do
            if inst:IsA("Model") or inst:IsA("Folder") then
                table.insert(candidates, inst)
            end
        end
    end

    for _, pet in ipairs(candidates) do
        local petName = pet.Name or "Unknown"
        local mps, source = getMpsFromPet(pet)
        if mps > 0 then
            table.insert(result, {
                name   = petName,
                mps    = mps,
                source = source or "unknown",
            })
        end
    end

    table.sort(result, function(a,b) return a.mps > b.mps end)
    return result
end

--==================================================
-- üì§ G·ª¨I L√äN DISCORD
--==================================================
local function sendDebug()
    local pets = collectPets()
    local jobId = game.JobId or "N/A"
    local placeId = game.PlaceId

    if #pets == 0 then
        local payload = {
            content = "üß™ **TEST PETS FINDER**\nKh√¥ng t√¨m th·∫•y pet n√†o c√≥ MPS > 0 trong server.\nJobId: `"
                      .. tostring(jobId) .. "`"
        }
        http_request_impl({
            Url = WEBHOOK_DEBUG,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(payload)
        })
        warn("[TEST] Kh√¥ng t√¨m th·∫•y pet n√†o c√≥ MPS.")
        return
    end

    local lines = {}
    table.insert(lines, "Name | MPS | Source")
    table.insert(lines, "----------------------------")

    for i, info in ipairs(pets) do
        if i > 25 then break end  -- tr√°nh b·∫£ng qu√° d√†i
        local line = string.format(
            "%s | %s/s | %s",
            tostring(info.name),
            formatMpsShort(info.mps),
            tostring(info.source)
        )
        table.insert(lines, line)
    end

    local tableBlock = "```" .. table.concat(lines, "\n") .. "```"

    local joinLink = ("https://chillihub1.github.io/chillihub-joiner/?placeId=%s&gameInstanceId=%s")
        :format(placeId, jobId)

    local payload = {
        content = table.concat({
            "üß™ **TEST PETS FINDER**",
            "üÜî JobId: `" .. tostring(jobId) .. "`",
            "üåê [JOIN HERE](" .. joinLink .. ")",
            tableBlock
        }, "\n")
    }

    http_request_impl({
        Url = WEBHOOK_DEBUG,
        Method = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body = HttpService:JSONEncode(payload)
    })

    warn("[TEST] ƒê√£ g·ª≠i danh s√°ch pet l√™n Discord, count =", #pets)
end

sendDebug()
